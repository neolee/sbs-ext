<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBS Editor</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f0f2f5;
        }
        .container {
            display: flex;
            height: 100vh;
            flex-direction: column;
        }
        .toolbar {
            height: 50px;
            background: #ffffff;
            border-bottom: 1px solid #dcdfe6;
            display: flex;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            z-index: 10;
        }
        .toolbar-left, .toolbar-right {
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 15px;
            flex: 1;
        }
        .toolbar-left {
            border-right: 1px solid #dcdfe6;
        }
        .toolbar h1 {
            margin: 0;
            font-size: 18px;
            color: #303133;
            margin-right: 10px;
        }
        .main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        #editor-container {
            flex: 1;
            height: 100%;
            background: #fff;
            display: flex;
            flex-direction: column;
        }
        .cm-editor {
            height: 100%;
        }
        #preview-container {
            flex: 1;
            background: #fff;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        #preview-shield {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: transparent;
            display: none;
            z-index: 100;
        }
        #resizer {
            width: 8px;
            background: #f0f2f5;
            cursor: col-resize;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            border-left: 1px solid #dcdfe6;
            border-right: 1px solid #dcdfe6;
            z-index: 5;
            margin-left: -1px;
        }
        #resizer:hover {
            background: #e4e7ed;
        }
        #resizer::after {
            content: "";
            width: 2px;
            height: 30px;
            background: #c0c4cc;
            border-radius: 1px;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .btn {
            padding: 6px 15px;
            cursor: pointer;
            background: #409eff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            transition: background 0.3s;
        }
        .btn:hover {
            background: #66b1ff;
        }
        .btn-secondary {
            background: #909399;
        }
        .btn-secondary:hover {
            background: #a6a9ad;
        }
        .btn-icon {
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            color: #606266;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .btn-icon:hover {
            background: #f5f7fa;
            color: #409eff;
            border-color: #c6e2ff;
        }
        .btn-icon svg {
            width: 18px;
            height: 18px;
        }
        select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #dcdfe6;
            outline: none;
        }
        .toolbar-label {
            font-size: 14px;
            color: #606266;
            margin-right: -5px;
        }
        .spacer {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="toolbar">
            <div class="toolbar-left">
                <h1>SBS Editor</h1>

                <span class="toolbar-label">Insert</span>
                <select id="widget-insert">
                    <option value="">Widget</option>
                    <option value="chess">Chess Board</option>
                    <option value="bridge">Bridge Deal</option>
                    <option value="go">Go Board</option>
                    <option value="sticky">Sticky Layout</option>
                </select>

                <span class="toolbar-label">Theme</span>
                <select id="theme-select">
                    <option value="default">Default</option>
                    <option value="classic">Classic</option>
                </select>

                <div class="spacer"></div>

                <div style="display: flex; gap: 8px;">
                    <button class="btn-icon" id="import-btn" title="Import Markdown">
                        <i data-lucide="file-up"></i>
                    </button>
                    <input type="file" id="import-input" accept=".md" style="display: none">

                    <button class="btn-icon" id="export-btn" title="Export Markdown">
                        <i data-lucide="file-down"></i>
                    </button>

                    <button class="btn-icon" id="render-btn" title="Render">
                        <i data-lucide="play"></i>
                    </button>
                </div>
            </div>
            <div class="toolbar-right" style="justify-content: flex-end;">
                <div style="display: flex; gap: 8px;">
                    <button class="btn-icon" id="view-toggle" title="Toggle Preview/Split View">
                        <i data-lucide="maximize-2" id="toggle-icon"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="main">
            <div id="editor-container"></div>
            <div id="resizer"></div>
            <div id="preview-container">
                <div id="preview-shield"></div>
                <iframe id="preview-frame"></iframe>
            </div>
        </div>
    </div>

    <!-- CodeMirror 6 dependencies via esm.sh -->
    <script type="module">
        import { EditorView, basicSetup } from "https://esm.sh/codemirror";
        import { EditorState } from "https://esm.sh/@codemirror/state";
        import { markdown } from "https://esm.sh/@codemirror/lang-markdown";
        import { keymap } from "https://esm.sh/@codemirror/view";
        import { indentWithTab } from "https://esm.sh/@codemirror/commands";

        const editorContainer = document.getElementById('editor-container');
        const previewContainer = document.getElementById('preview-container');
        const resizer = document.getElementById('resizer');
        const previewShield = document.getElementById('preview-shield');
        const previewFrame = document.getElementById('preview-frame');
        const renderBtn = document.getElementById('render-btn');
        const viewToggle = document.getElementById('view-toggle');
        const toggleIcon = document.getElementById('toggle-icon');
        const themeSelect = document.getElementById('theme-select');
        const widgetInsert = document.getElementById('widget-insert');
        const exportBtn = document.getElementById('export-btn');
        const importBtn = document.getElementById('import-btn');
        const importInput = document.getElementById('import-input');

        const initialDoc = `# SBS Editor Demo

Welcome to the **Smart Book Standard** editor.

## Chess Example

::: sbs-sticky
\`\`\`sbs-chess
title: "Sticky Chess Demo"
layout: "compact"
coords: true
orientation: "black"
interactive: true
---
r1bq1rk1/pp1n1pbp/3p1np1/2pPp3/2P1P3/2N2N2/PPQBBPPP/R3K2R w KQ - 0 11
\`\`\`
This is a sticky chess board. You can scroll the text on the right while the board stays visible.
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed non risus. Suspendisse lectus tortor, dignissim sit amet, adipiscing nec, ultricies sed, dolor.
:::

## Bridge Example

\`\`\`sbs-bridge
title: "Bridge Demo"
layout: "full"
---
[Main "Scenario 1"]
[Deal "N:AKQJ.AKQJ.AK.AQJ 9876.9876.8.K982 5432.5432.54.754 T.T.QJT97632.T63"]
[Declarer "N"]
[Contract "6H"]
[Result "13"]
\`\`\`

## Go Example

\`\`\`sbs-go
theme: book
size: 500
board: 19
showMoveNumbers: 10
interactive: true
---
(;GM[1]FF[4]SZ[19]AP[SmartGo:2.7.1]CA[UTF-8]GN[Demo Game]DT[2025-12-23]PB[Black Player]PW[White Player]BR[1d]WR[1d]KM[6.5]RE[B+R];B[pd];W[dp];B[pp];W[dd];B[pj];W[nc];B[qf];W[pb];B[qc];W[kc];B[fq];W[cn];B[jp];W[dr];B[cq];W[dq];B[cp];W[co];B[br];W[cr];B[bq];W[er];B[fr];W[bs];B[ar];W[do];B[bo];W[bn];B[ap];W[cf];B[ch];W[eg];B[eh];W[fg];B[fh];W[gh];B[gi];W[hi];B[gj];W[hj];B[hk];W[ik];B[hl];W[il];B[im];W[jm];B[in];W[jn];B[jo];W[ko];B[kp];W[lo];B[lp];W[mo];B[mp];W[no];B[np];W[oo];B[po];W[on];B[pn];W[om];B[pm];W[ol];B[pl];W[ok];B[pk];W[oj];B[oi];W[ni];B[oh];W[nh];B[ng];W[mg];B[mf];W[lg];B[lf];W[kf];B[ke];W[je];B[kd];W[jd];B[lc];W[kb];B[lb];W[la];B[ma];W[ka];B[mb];W[nb];B[na];W[oa];B[mc];W[nd];B[ne];W[oe];B[of];W[pe];B[qe];W[pf];B[pg];W[qg];B[qh];W[rg];B[rh];W[rf];B[re];W[se];B[rd];W[sd];B[sc];W[sf];B[rb];W[ra];B[qa];W[pa];B[qb];W[pc];B[pd])
\`\`\`
`;

        let lastRenderTime = 0;
        const RENDER_DEBOUNCE = 300;

        async function render() {
            const text = view.state.doc.toString();
            const theme = themeSelect.value;

            try {
                const response = await fetch('/api/render', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, theme })
                });
                const data = await response.json();

                // Using srcdoc for direct injection, which handles origin-relative paths (/widgets/...) reliably
                previewFrame.srcdoc = data.html;
            } catch (err) {
                console.error('Render failed:', err);
            }
        }

        const updateListener = EditorView.updateListener.of((update) => {
            if (update.docChanged) {
                const now = Date.now();
                if (now - lastRenderTime > RENDER_DEBOUNCE) {
                    lastRenderTime = now;
                    render();
                } else {
                    clearTimeout(window._renderTimer);
                    window._renderTimer = setTimeout(render, RENDER_DEBOUNCE);
                }
            }
        });

        const state = EditorState.create({
            doc: initialDoc,
            extensions: [
                basicSetup,
                markdown(),
                keymap.of([indentWithTab]),
                updateListener,
                EditorView.lineWrapping
            ]
        });

        const view = new EditorView({
            state,
            parent: editorContainer
        });

        renderBtn.addEventListener('click', render);
        themeSelect.addEventListener('change', render);

        widgetInsert.addEventListener('change', () => {
            const val = widgetInsert.value;
            if (!val) return;

            let snippet = "";
            if (val === 'chess') {
                snippet = "\n```sbs-chess\ntitle: \"Chess Game\"\nlayout: \"full\"\ncoords: true\ninteractive: true\n---\n1. e4 e5 2. Nf3 Nc6 3. Bb5 a6 4. Ba4 Nf6 5. O-O Be7\n```\n";
            } else if (val === 'bridge') {
                snippet = "\n```sbs-bridge\ntitle: \"Bridge Hand\"\nlayout: \"full\"\n---\n[Main \"Scenario\"]\n[Deal \"N:AKQJ.AKQJ.AK.AQJ 9876.9876.8.K982 5432.5432.54.754 T.T.QJT97632.T63\"]\n[Declarer \"N\"]\n[Contract \"6H\"]\n```\n";
            } else if (val === 'go') {
                snippet = "\n```sbs-go\ntitle: \"Go Game\"\nsize: 400\nboard: 19\nshowMoveNumbers: 0\ninteractive: true\n---\n(;GM[1]FF[4]SZ[19]PB[Black]PW[White];B[pd];W[dp];B[pp])\n```\n";
            } else if (val === 'sticky') {
                snippet = "\n::: sbs-sticky\n```sbs-chess\nlayout: \"mini\"\nsize: 300\n---\n1. e4 e5\n```\nYour narration text should be placed here. It will scroll while the widget remains sticky.\n:::\n";
            }

            if (snippet) {
                const cursor = view.state.selection.main.head;
                view.dispatch({
                    changes: { from: cursor, insert: snippet },
                    selection: { anchor: cursor + snippet.length }
                });
                view.focus();
            }
            widgetInsert.value = "";
        });

        exportBtn.addEventListener('click', () => {
            const text = view.state.doc.toString();
            const blob = new Blob([text], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'document.md';
            a.click();
            URL.revokeObjectURL(url);
        });

        importBtn.addEventListener('click', () => {
            importInput.click();
        });

        importInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                view.dispatch({
                    changes: { from: 0, to: view.state.doc.length, insert: content }
                });
                render();
            };
            reader.readAsText(file);
            // Reset input so the same file can be imported again if needed
            importInput.value = '';
        });

        // Resizer Logic
        let isResizing = false;
        let lastPercentage = 50;

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.cursor = 'col-resize';
            previewShield.style.display = 'block';
        });

        resizer.addEventListener('dblclick', () => {
            lastPercentage = 50;
            editorContainer.style.flex = `0 0 50%`;
            previewContainer.style.flex = `0 0 50%`;
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;

            const mainRect = document.querySelector('.main').getBoundingClientRect();
            const percentage = ((e.clientX - mainRect.left) / mainRect.width) * 100;

            if (percentage > 10 && percentage < 90) {
                lastPercentage = percentage;
                editorContainer.style.flex = `0 0 ${percentage}%`;
                previewContainer.style.flex = `0 0 ${100 - percentage}%`;
            }
        });

        window.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = 'default';
                previewShield.style.display = 'none';
            }
        });

        // View Toggles
        let isFullPreview = false;

        viewToggle.addEventListener('click', () => {
            isFullPreview = !isFullPreview;

            if (isFullPreview) {
                editorContainer.style.display = 'none';
                resizer.style.display = 'none';
                previewContainer.style.display = 'flex';
                previewContainer.style.flex = '1';
                toggleIcon.setAttribute('data-lucide', 'minimize-2');
            } else {
                editorContainer.style.display = 'flex';
                resizer.style.display = 'flex';
                previewContainer.style.display = 'flex';
                editorContainer.style.flex = `0 0 ${lastPercentage}%`;
                previewContainer.style.flex = `0 0 ${100 - lastPercentage}%`;
                toggleIcon.setAttribute('data-lucide', 'maximize-2');
            }
            lucide.createIcons();
        });

        // Initialize Lucide icons
        lucide.createIcons();

        // Initial render
        render();
    </script>
</body>
</html>
